"""‚Ä®SISTEMA DE FICHAJE AUTOMATIZADO - VERSI√ìN COMPLETA‚Ä®Incluye: Script de fichaje + Interfaz gr√°fica + Programador de horarios‚Ä®TODO EN UN SOLO ARCHIVO‚Ä®"""‚Ä®‚Ä®import os‚Ä®import sys‚Ä®import time‚Ä®import base64‚Ä®import requests‚Ä®import pandas as pd‚Ä®import logging‚Ä®import threading‚Ä®import schedule‚Ä®import json‚Ä®from datetime import datetime‚Ä®from pathlib import Path‚Ä®‚Ä®# Selenium‚Ä®from selenium import webdriver‚Ä®from selenium.webdriver.common.by import By‚Ä®from selenium.webdriver.chrome.service import Service as ChromeService‚Ä®from selenium.webdriver.support.ui import WebDriverWait‚Ä®from selenium.webdriver.support import expected_conditions as EC‚Ä®from selenium.common.exceptions import TimeoutException, WebDriverException‚Ä®from webdriver_manager.chrome import ChromeDriverManager‚Ä®‚Ä®# Tkinter para GUI‚Ä®import tkinter as tk‚Ä®from tkinter import ttk, scrolledtext, messagebox, filedialog‚Ä®‚Ä®# ==================== CONFIGURACI√ìN GLOBAL ====================‚Ä®CONFIG = {‚Ä®    'url': "http://172.22.0.132/",‚Ä®    'csv_file': "datos.csv",‚Ä®    'log_file': f"fichajes_{datetime.now().strftime('%Y%m%d')}.log",‚Ä®    'results_file': f"resultados_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",‚Ä®    'screenshots_dir': "screenshots",‚Ä®    'config_file': "horarios_config.json",‚Ä®    'headless': False,‚Ä®    'api_key_2captcha': os.getenv("API_KEY_2CAPTCHA", "41c8f96621747395fd9731ebd83a746c"),‚Ä®    'timeout_short': 5,‚Ä®    'timeout_medium': 10,‚Ä®    'timeout_long': 30‚Ä®}‚Ä®‚Ä®# Crear directorios necesarios‚Ä®os.makedirs(CONFIG['screenshots_dir'], exist_ok=True)‚Ä®‚Ä®# ==================== CONFIGURACI√ìN DE LOGS ====================‚Ä®logging.basicConfig(‚Ä®    level=logging.INFO,‚Ä®    format='%(asctime)s - %(levelname)s - %(message)s',‚Ä®    handlers=[‚Ä®        logging.FileHandler(CONFIG['log_file'], encoding='utf-8'),‚Ä®        logging.StreamHandler()‚Ä®    ]‚Ä®)‚Ä®logger = logging.getLogger(__name__)‚Ä®‚Ä®‚Ä®# ==================== CLASE PARA EL MOTOR DE FICHAJE ====================‚Ä®class FichajeEngine:‚Ä®    """Motor de fichaje con todas las funciones necesarias"""‚Ä®‚Ä®    def __init__(self, config):‚Ä®        self.config = config‚Ä®‚Ä®    def start_driver(self, headless=False):‚Ä®        """Inicia el driver de Chrome con configuraci√≥n optimizada"""‚Ä®        try:‚Ä®            options = webdriver.ChromeOptions()‚Ä®            if headless:‚Ä®                options.add_argument("--headless=new")‚Ä®‚Ä®            # Opciones para mayor estabilidad‚Ä®            options.add_argument("--no-sandbox")‚Ä®            options.add_argument("--disable-dev-shm-usage")‚Ä®            options.add_argument("--disable-gpu")‚Ä®            options.add_argument("--disable-software-rasterizer")‚Ä®            options.add_argument("--disable-extensions")‚Ä®            options.add_argument("--disable-blink-features=AutomationControlled")‚Ä®            options.add_experimental_option("excludeSwitches", ["enable-automation"])‚Ä®            options.add_experimental_option('useAutomationExtension', False)‚Ä®‚Ä®            prefs = {‚Ä®                "profile.default_content_setting_values.notifications": 2,‚Ä®                "profile.default_content_settings.popups": 0‚Ä®            }‚Ä®            options.add_experimental_option("prefs", prefs)‚Ä®‚Ä®            driver = webdriver.Chrome(‚Ä®                service=ChromeService(ChromeDriverManager().install()),‚Ä®                options=options‚Ä®            )‚Ä®            driver.set_window_size(1200, 900)‚Ä®            driver.set_page_load_timeout(60)‚Ä®‚Ä®            logger.info("‚úÖ Driver de Chrome iniciado correctamente")‚Ä®            return driver‚Ä®        except Exception as e:‚Ä®            logger.error(f"‚ùå Error iniciando driver: {e}")‚Ä®            raise‚Ä®‚Ä®    def solve_captcha_2captcha(self, image_path, api_key, timeout=120):‚Ä®        """Resuelve captcha usando API de 2Captcha"""‚Ä®        try:‚Ä®            with open(image_path, "rb") as f:‚Ä®                b64 = base64.b64encode(f.read()).decode()‚Ä®‚Ä®            logger.info("üì§ Enviando captcha a 2Captcha...")‚Ä®            r = requests.post("http://2captcha.com/in.php", data={‚Ä®                "method": "base64",‚Ä®                "key": api_key,‚Ä®                "body": b64,‚Ä®                "json": 1‚Ä®            }, timeout=10).json()‚Ä®‚Ä®            if r.get("status") != 1:‚Ä®                logger.error(f"‚ùå Error enviando captcha: {r}")‚Ä®                return None‚Ä®‚Ä®            captcha_id = r["request"]‚Ä®            logger.info(f"‚è≥ Esperando respuesta de captcha...")‚Ä®‚Ä®            for _ in range(timeout // 5):‚Ä®                time.sleep(5)‚Ä®                res = requests.get("http://2captcha.com/res.php", params={‚Ä®                    "key": api_key,‚Ä®                    "action": "get",‚Ä®                    "id": captcha_id,‚Ä®                    "json": 1‚Ä®                }, timeout=10).json()‚Ä®‚Ä®                if res.get("status") == 1:‚Ä®                    logger.info(f"‚úÖ Captcha resuelto: {res['request']}")‚Ä®                    return res["request"]‚Ä®                if res.get("request") != "CAPCHA_NOT_READY":‚Ä®                    logger.error(f"‚ùå Error resolviendo captcha: {res}")‚Ä®                    return None‚Ä®‚Ä®            logger.warning("‚è± Timeout esperando respuesta de 2Captcha")‚Ä®            return None‚Ä®        except Exception as e:‚Ä®            logger.error(f"‚ùå Error en 2Captcha: {e}")‚Ä®            return None‚Ä®‚Ä®    def find_captcha_image(self, driver):‚Ä®        """Busca la imagen del captcha"""‚Ä®        try:‚Ä®            imgs = driver.find_elements(By.TAG_NAME, "img")‚Ä®            for img in imgs:‚Ä®                src = (img.get_attribute("src") or "").lower()‚Ä®                if "captcha" in src or "codigo" in src:‚Ä®                    logger.info("‚úÖ Imagen de captcha encontrada")‚Ä®                    return img‚Ä®            logger.warning("‚ö†Ô∏è No se encontr√≥ imagen de captcha")‚Ä®            return None‚Ä®        except Exception as e:‚Ä®            logger.error(f"‚ùå Error buscando captcha: {e}")‚Ä®            return None‚Ä®‚Ä®    def take_screenshot(self, driver, filename):‚Ä®        """Captura screenshot con timestamp"""‚Ä®        try:‚Ä®            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")‚Ä®            filepath = os.path.join(self.config['screenshots_dir'], f"{timestamp}_{filename}")‚Ä®            driver.save_screenshot(filepath)‚Ä®            logger.info(f"üì∏ Screenshot guardado: {filepath}")‚Ä®            return filepath‚Ä®        except Exception as e:‚Ä®            logger.error(f"‚ùå Error guardando screenshot: {e}")‚Ä®            return ""‚Ä®‚Ä®    def guardar_resultado(self, usuario, estado, mensaje, screenshot_path=""):‚Ä®        """Guarda el resultado del fichaje en CSV"""‚Ä®        try:‚Ä®            resultado = {‚Ä®                'fecha_hora': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),‚Ä®                'usuario': usuario,‚Ä®                'estado': estado,‚Ä®                'mensaje': mensaje,‚Ä®                'screenshot': screenshot_path‚Ä®            }‚Ä®‚Ä®            df = pd.DataFrame([resultado])‚Ä®‚Ä®            if os.path.exists(self.config['results_file']):‚Ä®                df.to_csv(self.config['results_file'], mode='a', header=False, index=False, encoding='utf-8')‚Ä®            else:‚Ä®                df.to_csv(self.config['results_file'], mode='w', header=True, index=False, encoding='utf-8')‚Ä®‚Ä®            logger.info(f"üìù Resultado guardado")‚Ä®        except Exception as e:‚Ä®            logger.error(f"‚ùå Error guardando resultado: {e}")‚Ä®‚Ä®    def safe_click(self, driver, element, description="elemento"):‚Ä®        """Hace clic de forma segura con m√∫ltiples intentos"""‚Ä®        try:‚Ä®            driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", element)‚Ä®            time.sleep(0.3)‚Ä®            element.click()‚Ä®            logger.info(f"‚úÖ Clic en {description}")‚Ä®            return True‚Ä®        except Exception as e1:‚Ä®            try:‚Ä®                driver.execute_script("arguments[0].click();", element)‚Ä®                logger.info(f"‚úÖ Clic con JS en {description}")‚Ä®                return True‚Ä®            except Exception as e2:‚Ä®                logger.error(f"‚ùå No se pudo hacer clic en {description}")‚Ä®                return False‚Ä®‚Ä®    def realizar_fichaje(self, usuario, password, driver, callback=None):‚Ä®        """Realiza el proceso completo de fichaje"""‚Ä®        logger.info(f"\n{'=' * 70}")‚Ä®        logger.info(f"üöÄ FICHAJE PARA: {usuario}")‚Ä®        logger.info(f"{'=' * 70}")‚Ä®‚Ä®        if callback:‚Ä®            callback(f"Iniciando fichaje para {usuario}...")‚Ä®‚Ä®        screenshot_path = ""‚Ä®‚Ä®        try:‚Ä®            # 1. Cargar p√°gina‚Ä®            logger.info("üìç Cargando p√°gina de login...")‚Ä®            if callback:‚Ä®                callback("Cargando p√°gina de login...")‚Ä®            driver.get(self.config['url'])‚Ä®            time.sleep(3)‚Ä®‚Ä®            # 2. Entrar a frames‚Ä®            logger.info("üîÄ Entrando a frames...")‚Ä®            if callback:‚Ä®                callback("Accediendo al sistema...")‚Ä®            driver.switch_to.frame("cuerpo_WCRONOS")‚Ä®            time.sleep(1)‚Ä®            driver.switch_to.frame("principal_wcronos")‚Ä®            time.sleep(1)‚Ä®‚Ä®            # 3. Localizar campos‚Ä®            logger.info("üîç Localizando campos del formulario...")‚Ä®            if callback:‚Ä®                callback("Localizando formulario de login...")‚Ä®‚Ä®            tarjeta_field = WebDriverWait(driver, self.config['timeout_medium']).until(‚Ä®                EC.presence_of_element_located((By.ID, "USUARIO"))‚Ä®            )‚Ä®            contrasena_field = driver.find_element(By.ID, "CONTRASENA")‚Ä®            captcha_field = driver.find_element(By.NAME, "codigo_captcha")‚Ä®‚Ä®            # 4. Captcha‚Ä®            captcha_value = None‚Ä®            captcha_img = self.find_captcha_image(driver)‚Ä®‚Ä®            if captcha_img:‚Ä®                if callback:‚Ä®                    callback("Resolviendo captcha...")‚Ä®                captcha_path = f"captcha_{usuario}_{datetime.now().strftime('%H%M%S')}.png"‚Ä®                try:‚Ä®                    captcha_img.screenshot(captcha_path)‚Ä®                    captcha_value = self.solve_captcha_2captcha(captcha_path, self.config['api_key_2captcha'])‚Ä®                    os.remove(captcha_path)‚Ä®                except:‚Ä®                    pass‚Ä®‚Ä®            if not captcha_value:‚Ä®                captcha_value = "0000"‚Ä®‚Ä®            # 5. Rellenar formulario‚Ä®            logger.info("üìù Rellenando formulario...")‚Ä®            if callback:‚Ä®                callback("Ingresando credenciales...")‚Ä®‚Ä®            tarjeta_field.clear()‚Ä®            tarjeta_field.send_keys(usuario)‚Ä®            time.sleep(0.5)‚Ä®‚Ä®            contrasena_field.clear()‚Ä®            contrasena_field.send_keys(password)‚Ä®            time.sleep(0.5)‚Ä®‚Ä®            captcha_field.clear()‚Ä®            captcha_field.send_keys(captcha_value)‚Ä®            time.sleep(0.5)‚Ä®‚Ä®            screenshot_path = self.take_screenshot(driver, f"antes_login_{usuario}.png")‚Ä®‚Ä®            # 6. Hacer clic en ENTRAR‚Ä®            logger.info("üîç Buscando bot√≥n ENTRAR...")‚Ä®            if callback:‚Ä®                callback("Haciendo login...")‚Ä®‚Ä®            botones = driver.find_elements(By.XPATH, "//button | //input[@type='submit']")‚Ä®            entrar_clicked = False‚Ä®            for btn in botones:‚Ä®                texto = (btn.text or "").lower()‚Ä®                value = (btn.get_attribute("value") or "").lower()‚Ä®                if "entrar" in texto or "entrar" in value:‚Ä®                    if self.safe_click(driver, btn, "bot√≥n ENTRAR"):‚Ä®                        entrar_clicked = True‚Ä®                        break‚Ä®‚Ä®            if not entrar_clicked:‚Ä®                raise Exception("No se pudo hacer clic en ENTRAR")‚Ä®‚Ä®            # 7. Esperar redirecci√≥n‚Ä®            time.sleep(5)‚Ä®            logger.info(f"üìç Login completado")‚Ä®‚Ä®            # 8. Ir a Punto de Fichaje‚Ä®            if callback:‚Ä®                callback("Navegando a punto de fichaje...")‚Ä®            time.sleep(2)‚Ä®‚Ä®            boton_fichaje = driver.find_element(‚Ä®                By.XPATH,‚Ä®                "//button[contains(@onclick, 'form_pfichaje.submit')]"‚Ä®            )‚Ä®            onclick = boton_fichaje.get_attribute("onclick")‚Ä®            driver.execute_script(onclick)‚Ä®            logger.info("‚úÖ Navegando a Punto De Fichaje")‚Ä®            time.sleep(4)‚Ä®‚Ä®            # 9. Volver a entrar en frames‚Ä®            driver.switch_to.default_content()‚Ä®            time.sleep(1)‚Ä®            driver.switch_to.frame("cuerpo_WCRONOS")‚Ä®            time.sleep(1)‚Ä®            driver.switch_to.frame("principal_wcronos")‚Ä®            time.sleep(1)‚Ä®‚Ä®            # 10. REALIZAR FICHAJE‚Ä®            logger.info("üîç Buscando bot√≥n 'Realizar Fichaje'...")‚Ä®            if callback:‚Ä®                callback("Realizando fichaje...")‚Ä®‚Ä®            fichaje_realizado = False‚Ä®‚Ä®            # Intento 1: Por ID‚Ä®            try:‚Ä®                boton = driver.find_element(By.ID, "btnEnviarForm")‚Ä®                if self.safe_click(driver, boton, "Realizar Fichaje"):‚Ä®                    fichaje_realizado = True‚Ä®            except:‚Ä®                pass‚Ä®‚Ä®            # Intento 2: Por texto‚Ä®            if not fichaje_realizado:‚Ä®                try:‚Ä®                    botones = driver.find_elements(By.XPATH,‚Ä®                                                   "//button[contains(., 'Realizar Fichaje')] | //button[contains(., 'Fichar')]")‚Ä®                    if botones and self.safe_click(driver, botones[0], "Realizar Fichaje"):‚Ä®                        fichaje_realizado = True‚Ä®                except:‚Ä®                    pass‚Ä®‚Ä®            # Intento 3: Submit‚Ä®            if not fichaje_realizado:‚Ä®                driver.execute_script("""‚Ä®                    let btn = document.getElementById('btnEnviarForm');‚Ä®                    if (btn && btn.form) btn.form.submit();‚Ä®                """)‚Ä®                fichaje_realizado = True‚Ä®‚Ä®            if not fichaje_realizado:‚Ä®                raise Exception("No se pudo realizar el fichaje")‚Ä®‚Ä®            # 11. Verificar resultado‚Ä®            time.sleep(3)‚Ä®            screenshot_path = self.take_screenshot(driver, f"resultado_{usuario}.png")‚Ä®‚Ä®            # GUARDAR HTML COMPLETO PARA DEBUG‚Ä®            try:‚Ä®                page_html = driver.page_source‚Ä®                html_file = os.path.join(self.config['screenshots_dir'],‚Ä®                                         f"html_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{usuario}.html")‚Ä®                with open(html_file, 'w', encoding='utf-8') as f:‚Ä®                    f.write(page_html)‚Ä®                logger.info(f"üìÑ HTML guardado en: {html_file}")‚Ä®‚Ä®                # Imprimir HTML en consola tambi√©n‚Ä®                print("\n" + "=" * 80)‚Ä®                print("üîç HTML COMPLETO DE LA P√ÅGINA RESULTADO:")‚Ä®                print("=" * 80)‚Ä®                print(page_html)‚Ä®                print("=" * 80)‚Ä®                print("FIN DEL HTML")‚Ä®                print("=" * 80 + "\n")‚Ä®            except Exception as e:‚Ä®                logger.error(f"Error guardando HTML: {e}")‚Ä®‚Ä®            # Obtener el texto de la p√°gina‚Ä®            page_text = driver.page_source.lower()‚Ä®‚Ä®            # INDICADORES DE √âXITO - Por prioridad (m√°s espec√≠ficos primero)‚Ä®            success_indicators_alta_prioridad = [‚Ä®                "el fichaje se a realizado correctamente",  # Mensaje EXACTO‚Ä®                "el fichaje se ha realizado correctamente",  # Variante con H‚Ä®                "fichaje se a realizado correctamente",‚Ä®                "fichaje se ha realizado correctamente",‚Ä®                "se a realizado correctamente",‚Ä®                "se ha realizado correctamente",‚Ä®            ]‚Ä®‚Ä®            success_indicators_media_prioridad = [‚Ä®                "fichaje realizado",‚Ä®                "fichaje a√±adido",‚Ä®                "fichaje registrado",‚Ä®                "a√±adido con √©xito",‚Ä®                "registrado con √©xito",‚Ä®                "realizado con √©xito",‚Ä®                "fichaje correcto",‚Ä®                "operaci√≥n exitosa",‚Ä®                "guardado correctamente",‚Ä®            ]‚Ä®‚Ä®            success_indicators_baja_prioridad = [‚Ä®                "√©xito",‚Ä®                "exitoso",‚Ä®                "correctamente",‚Ä®                "confirmado",‚Ä®                "completado"‚Ä®            ]‚Ä®‚Ä®            # INDICADORES DE ERROR - Solo mensajes claros de error‚Ä®            error_indicators_especificos = [‚Ä®                "error al realizar",‚Ä®                "error en el fichaje",‚Ä®                "fichaje incorrecto",‚Ä®                "fichaje fallido",‚Ä®                "no se pudo realizar",‚Ä®                "operaci√≥n fallida",‚Ä®                "fichaje rechazado",‚Ä®                "no se ha podido",‚Ä®                "ha ocurrido un error"‚Ä®            ]‚Ä®‚Ä®            # PASO 1: Buscar indicadores de ALTA PRIORIDAD (mensajes espec√≠ficos de √©xito)‚Ä®            for indicator in success_indicators_alta_prioridad:‚Ä®                if indicator in page_text:‚Ä®                    logger.info(f"‚úÖ‚úÖ‚úÖ FICHAJE EXITOSO para {usuario}")‚Ä®                    logger.info(f"   Mensaje detectado (ALTA PRIORIDAD): '{indicator}'")‚Ä®                    if callback:‚Ä®                        callback(f"‚úÖ Fichaje exitoso para {usuario}")‚Ä®                    self.guardar_resultado(usuario, "√âXITO", f"Fichaje completado: {indicator}", screenshot_path)‚Ä®                    return True‚Ä®‚Ä®            # PASO 2: Buscar errores ESPEC√çFICOS (solo si no encontramos √©xito de alta prioridad)‚Ä®            error_especifico_found = False‚Ä®            error_message = ""‚Ä®            for indicator in error_indicators_especificos:‚Ä®                if indicator in page_text:‚Ä®                    error_especifico_found = True‚Ä®                    error_message = indicator‚Ä®                    break‚Ä®‚Ä®            if error_especifico_found:‚Ä®                logger.error(f"‚ùå FICHAJE FALLIDO para {usuario}")‚Ä®                logger.error(f"   Error ESPEC√çFICO detectado: '{error_message}'")‚Ä®                if callback:‚Ä®                    callback(f"‚ùå Error en fichaje para {usuario}")‚Ä®                self.guardar_resultado(usuario, "ERROR", f"Error espec√≠fico: {error_message}", screenshot_path)‚Ä®                return False‚Ä®‚Ä®            # PASO 3: Buscar indicadores de MEDIA PRIORIDAD‚Ä®            for indicator in success_indicators_media_prioridad:‚Ä®                if indicator in page_text:‚Ä®                    logger.info(f"‚úÖ‚úÖ‚úÖ FICHAJE EXITOSO para {usuario}")‚Ä®                    logger.info(f"   Mensaje detectado (MEDIA PRIORIDAD): '{indicator}'")‚Ä®                    if callback:‚Ä®                        callback(f"‚úÖ Fichaje exitoso para {usuario}")‚Ä®                    self.guardar_resultado(usuario, "√âXITO", f"Fichaje completado: {indicator}", screenshot_path)‚Ä®                    return True‚Ä®‚Ä®            # PASO 4: Buscar indicadores de BAJA PRIORIDAD‚Ä®            for indicator in success_indicators_baja_prioridad:‚Ä®                if indicator in page_text:‚Ä®                    logger.info(f"‚úÖ‚úÖ‚úÖ FICHAJE EXITOSO para {usuario}")‚Ä®                    logger.info(f"   Mensaje detectado (BAJA PRIORIDAD): '{indicator}'")‚Ä®                    if callback:‚Ä®                        callback(f"‚úÖ Fichaje exitoso para {usuario}")‚Ä®                    self.guardar_resultado(usuario, "√âXITO", f"Fichaje completado: {indicator}", screenshot_path)‚Ä®                    return True‚Ä®‚Ä®            # PASO 5: Si no encontramos nada claro, intentar con el t√≠tulo‚Ä®            try:‚Ä®                page_title = driver.title.lower()‚Ä®                if any(word in page_title for word in ["√©xito", "correcto", "confirmado", "realizado"]):‚Ä®                    logger.info(f"‚úÖ‚úÖ‚úÖ FICHAJE EXITOSO para {usuario} (detectado en t√≠tulo)")‚Ä®                    if callback:‚Ä®                        callback(f"‚úÖ Fichaje exitoso para {usuario}")‚Ä®                    self.guardar_resultado(usuario, "√âXITO", "Fichaje completado (t√≠tulo)", screenshot_path)‚Ä®                    return True‚Ä®            except:‚Ä®                pass‚Ä®‚Ä®            # PASO 6: Si llegamos aqu√≠, no pudimos determinar el estado‚Ä®            logger.warning(f"‚ö†Ô∏è ESTADO DESCONOCIDO para {usuario}")‚Ä®            logger.warning(f"   No se encontraron indicadores claros de √©xito o error")‚Ä®            logger.warning(f"   Revisa el screenshot: {screenshot_path}")‚Ä®            if callback:‚Ä®                callback(f"‚ö†Ô∏è Estado desconocido para {usuario}")‚Ä®            self.guardar_resultado(usuario, "DESCONOCIDO", "Estado no determinado - revisar screenshot",‚Ä®                                   screenshot_path)‚Ä®            return None‚Ä®‚Ä®        except WebDriverException as e:‚Ä®            logger.error(f"‚ùå ERROR DE CHROMEDRIVER para {usuario}")‚Ä®            if callback:‚Ä®                callback(f"‚ùå Error de Chrome para {usuario}")‚Ä®            screenshot_path = self.take_screenshot(driver, f"error_{usuario}.png")‚Ä®            self.guardar_resultado(usuario, "ERROR", "Chrome crash", screenshot_path)‚Ä®            return False‚Ä®        except Exception as e:‚Ä®            logger.error(f"‚ùå ERROR para {usuario}: {e}")‚Ä®            if callback:‚Ä®                callback(f"‚ùå Error: {str(e)[:50]}")‚Ä®            screenshot_path = self.take_screenshot(driver, f"error_{usuario}.png")‚Ä®            self.guardar_resultado(usuario, "ERROR", str(e)[:200], screenshot_path)‚Ä®            return False‚Ä®‚Ä®    def procesar_usuarios(self, callback=None):‚Ä®        """Procesa todos los usuarios del CSV"""‚Ä®        logger.info("\n" + "=" * 80)‚Ä®        logger.info("üöÄ INICIANDO SISTEMA DE FICHAJE")‚Ä®        logger.info("=" * 80 + "\n")‚Ä®‚Ä®        if callback:‚Ä®            callback("Iniciando sistema de fichaje...")‚Ä®‚Ä®        # Verificar CSV‚Ä®        if not os.path.exists(self.config['csv_file']):‚Ä®            msg = f"‚ùå No existe {self.config['csv_file']}"‚Ä®            logger.error(msg)‚Ä®            if callback:‚Ä®                callback(msg)‚Ä®            return {'exitos': 0, 'fallos': 0, 'desconocidos': 0, 'total': 0}‚Ä®‚Ä®        # Cargar datos‚Ä®        try:‚Ä®            df = pd.read_csv(self.config['csv_file'])‚Ä®            if df.empty:‚Ä®                logger.error("‚ùå El CSV est√° vac√≠o")‚Ä®                if callback:‚Ä®                    callback("‚ùå El CSV est√° vac√≠o")‚Ä®                return {'exitos': 0, 'fallos': 0, 'desconocidos': 0, 'total': 0}‚Ä®            logger.info(f"‚úÖ Cargados {len(df)} usuarios")‚Ä®            if callback:‚Ä®                callback(f"‚úÖ Cargados {len(df)} usuarios")‚Ä®        except Exception as e:‚Ä®            logger.error(f"‚ùå Error leyendo CSV: {e}")‚Ä®            if callback:‚Ä®                callback(f"‚ùå Error leyendo CSV: {e}")‚Ä®            return {'exitos': 0, 'fallos': 0, 'desconocidos': 0, 'total': 0}‚Ä®‚Ä®        # Procesar‚Ä®        driver = None‚Ä®        exitos = 0‚Ä®        fallos = 0‚Ä®        desconocidos = 0‚Ä®‚Ä®        for i, row in df.iterrows():‚Ä®            usuario = str(row["tarjeta"]).strip()‚Ä®            password = str(row["contrasena"]).strip()‚Ä®‚Ä®            logger.info(f"\n{'=' * 80}")‚Ä®            logger.info(f"üìã USUARIO {i + 1}/{len(df)}: {usuario}")‚Ä®            logger.info(f"{'=' * 80}")‚Ä®‚Ä®            if callback:‚Ä®                callback(f"\n{'=' * 60}\nüìã Procesando {i + 1}/{len(df)}: {usuario}\n{'=' * 60}")‚Ä®‚Ä®            try:‚Ä®                if driver:‚Ä®                    try:‚Ä®                        driver.quit()‚Ä®                    except:‚Ä®                        pass‚Ä®                    time.sleep(2)‚Ä®‚Ä®                driver = self.start_driver(self.config['headless'])‚Ä®                resultado = self.realizar_fichaje(usuario, password, driver, callback)‚Ä®‚Ä®                if resultado is True:‚Ä®                    exitos += 1‚Ä®                elif resultado is False:‚Ä®                    fallos += 1‚Ä®                else:‚Ä®                    desconocidos += 1‚Ä®‚Ä®            except Exception as e:‚Ä®                logger.error(f"‚ùå Error cr√≠tico procesando {usuario}: {e}")‚Ä®                if callback:‚Ä®                    callback(f"‚ùå Error cr√≠tico: {str(e)[:50]}")‚Ä®                fallos += 1‚Ä®                self.guardar_resultado(usuario, "ERROR", f"Error cr√≠tico: {str(e)[:100]}", "")‚Ä®‚Ä®            if i < len(df) - 1:‚Ä®                logger.info("‚è∏ Pausa de 3 segundos...")‚Ä®                time.sleep(3)‚Ä®‚Ä®        # Cerrar driver‚Ä®        if driver:‚Ä®            try:‚Ä®                driver.quit()‚Ä®                logger.info("üîö Driver cerrado")‚Ä®            except:‚Ä®                pass‚Ä®‚Ä®        # Resumen‚Ä®        logger.info("\n" + "=" * 80)‚Ä®        logger.info("üìä RESUMEN FINAL")‚Ä®        logger.info("=" * 80)‚Ä®        logger.info(f"‚úÖ Exitosos: {exitos}")‚Ä®        logger.info(f"‚ùå Fallidos: {fallos}")‚Ä®        logger.info(f"‚ö†Ô∏è Desconocidos: {desconocidos}")‚Ä®        logger.info(f"üìÅ Total: {len(df)}")‚Ä®        logger.info("=" * 80 + "\n")‚Ä®‚Ä®        if callback:‚Ä®            callback(f"\n{'=' * 60}\nüìä RESUMEN FINAL\n{'=' * 60}")‚Ä®            callback(f"‚úÖ Exitosos: {exitos}")‚Ä®            callback(f"‚ùå Fallidos: {fallos}")‚Ä®            callback(f"‚ö†Ô∏è Desconocidos: {desconocidos}")‚Ä®            callback(f"üìÅ Total procesados: {len(df)}")‚Ä®            callback(f"üìÑ Resultados en: {self.config['results_file']}")‚Ä®            callback(f"{'=' * 60}\n")‚Ä®‚Ä®        return {'exitos': exitos, 'fallos': fallos, 'desconocidos': desconocidos, 'total': len(df)}‚Ä®‚Ä®‚Ä®# ==================== INTERFAZ GR√ÅFICA ====================‚Ä®class FichajeGUI:‚Ä®    """Interfaz gr√°fica con programador de horarios"""‚Ä®‚Ä®    def __init__(self, root, engine):‚Ä®        self.root = root‚Ä®        self.engine = engine‚Ä®        self.root.title("Sistema de Fichaje Automatizado v2.0")‚Ä®        self.root.geometry("950x750")  # Aumentado para acomodar m√°s elementos‚Ä®‚Ä®        # Variables‚Ä®        self.horarios = []‚Ä®        self.scheduler_running = False‚Ä®        self.scheduler_thread = None‚Ä®‚Ä®        # Cargar configuraci√≥n‚Ä®        self.cargar_configuracion()‚Ä®‚Ä®        # Crear interfaz‚Ä®        self.crear_interfaz()‚Ä®‚Ä®        # Protocolo de cierre‚Ä®        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)‚Ä®‚Ä®    def crear_interfaz(self):‚Ä®        """Crea todos los elementos de la interfaz"""‚Ä®‚Ä®        # T√çTULO‚Ä®        frame_titulo = tk.Frame(self.root, bg="#2c3e50", pady=15)‚Ä®        frame_titulo.pack(fill=tk.X)‚Ä®‚Ä®        tk.Label(frame_titulo,‚Ä®                 text="üïí SISTEMA DE FICHAJE AUTOMATIZADO",‚Ä®                 font=("Arial", 16, "bold"),‚Ä®                 bg="#2c3e50",‚Ä®                 fg="white").pack()‚Ä®‚Ä®        tk.Label(frame_titulo,‚Ä®                 text="Versi√≥n 2.0 - Con Programador de Horarios y D√≠as",‚Ä®                 font=("Arial", 10),‚Ä®                 bg="#2c3e50",‚Ä®                 fg="#ecf0f1").pack()‚Ä®‚Ä®        # PANEL SUPERIOR: Configuraci√≥n de archivo‚Ä®        frame_config = tk.LabelFrame(self.root,‚Ä®                                     text="‚öôÔ∏è Configuraci√≥n",‚Ä®                                     font=("Arial", 10, "bold"),‚Ä®                                     padx=10, pady=10)‚Ä®        frame_config.pack(fill=tk.X, padx=10, pady=5)‚Ä®‚Ä®        frame_csv = tk.Frame(frame_config)‚Ä®        frame_csv.pack(fill=tk.X, pady=5)‚Ä®‚Ä®        tk.Label(frame_csv, text="Archivo CSV:", font=("Arial", 9)).pack(side=tk.LEFT, padx=5)‚Ä®        self.csv_entry = tk.Entry(frame_csv, width=40, font=("Arial", 9))‚Ä®        self.csv_entry.insert(0, CONFIG['csv_file'])‚Ä®        self.csv_entry.pack(side=tk.LEFT, padx=5)‚Ä®‚Ä®        tk.Button(frame_csv, text="üìÅ Examinar", command=self.seleccionar_csv,‚Ä®                  bg="#3498db", fg="white", font=("Arial", 8), padx=10).pack(side=tk.LEFT)‚Ä®‚Ä®        # Checkbox para modo Headless‚Ä®        frame_headless = tk.Frame(frame_config)‚Ä®        frame_headless.pack(fill=tk.X, pady=5)‚Ä®‚Ä®        self.headless_var = tk.BooleanVar(value=CONFIG['headless'])‚Ä®        tk.Checkbutton(frame_headless,‚Ä®                       text="üîá Modo Headless (Chrome invisible - recomendado para producci√≥n)",‚Ä®                       variable=self.headless_var,‚Ä®                       font=("Arial", 9),‚Ä®                       command=self.toggle_headless).pack(side=tk.LEFT, padx=5)‚Ä®‚Ä®        # HORARIOS‚Ä®        frame_horarios = tk.LabelFrame(self.root,‚Ä®                                       text="‚è∞ Programaci√≥n de Horarios y D√≠as",‚Ä®                                       font=("Arial", 11, "bold"),‚Ä®                                       padx=15, pady=15)‚Ä®        frame_horarios.pack(fill=tk.X, padx=10, pady=10)‚Ä®‚Ä®        # Selector de hora‚Ä®        frame_selector = tk.Frame(frame_horarios)‚Ä®        frame_selector.pack(fill=tk.X, pady=5)‚Ä®‚Ä®        tk.Label(frame_selector,‚Ä®                 text="Hora:",‚Ä®                 font=("Arial", 10, "bold")).pack(side=tk.LEFT, padx=5)‚Ä®‚Ä®        self.hora_var = tk.StringVar(value="07")‚Ä®        tk.Spinbox(frame_selector,‚Ä®                   from_=0, to=23,‚Ä®                   textvariable=self.hora_var,‚Ä®                   width=5,‚Ä®                   font=("Arial", 11, "bold"),‚Ä®                   format="%02.0f").pack(side=tk.LEFT, padx=2)‚Ä®‚Ä®        tk.Label(frame_selector, text=":", font=("Arial", 14, "bold")).pack(side=tk.LEFT)‚Ä®‚Ä®        self.minuto_var = tk.StringVar(value="00")‚Ä®        tk.Spinbox(frame_selector,‚Ä®                   from_=0, to=59,‚Ä®                   textvariable=self.minuto_var,‚Ä®                   width=5,‚Ä®                   font=("Arial", 11, "bold"),‚Ä®                   format="%02.0f").pack(side=tk.LEFT, padx=2)‚Ä®‚Ä®        # Selector de d√≠as de la semana‚Ä®        frame_dias = tk.Frame(frame_horarios)‚Ä®        frame_dias.pack(fill=tk.X, pady=10)‚Ä®‚Ä®        tk.Label(frame_dias,‚Ä®                 text="D√≠as de la semana:",‚Ä®                 font=("Arial", 10, "bold")).pack(side=tk.LEFT, padx=5)‚Ä®‚Ä®        # Variables para cada d√≠a‚Ä®        self.dias_vars = {‚Ä®            'L': tk.BooleanVar(value=True),  # Lunes‚Ä®            'M': tk.BooleanVar(value=True),  # Martes‚Ä®            'X': tk.BooleanVar(value=True),  # Mi√©rcoles‚Ä®            'J': tk.BooleanVar(value=True),  # Jueves‚Ä®            'V': tk.BooleanVar(value=True),  # Viernes‚Ä®            'S': tk.BooleanVar(value=False),  # S√°bado‚Ä®            'D': tk.BooleanVar(value=False)  # Domingo‚Ä®        }‚Ä®‚Ä®        dias_nombres = {‚Ä®            'L': 'Lun',‚Ä®            'M': 'Mar',‚Ä®            'X': 'Mi√©',‚Ä®            'J': 'Jue',‚Ä®            'V': 'Vie',‚Ä®            'S': 'S√°b',‚Ä®            'D': 'Dom'‚Ä®        }‚Ä®‚Ä®        for key, nombre in dias_nombres.items():‚Ä®            tk.Checkbutton(frame_dias,‚Ä®                           text=nombre,‚Ä®                           variable=self.dias_vars[key],‚Ä®                           font=("Arial", 9)).pack(side=tk.LEFT, padx=3)‚Ä®‚Ä®        # Bot√≥n para seleccionar/deseleccionar todos‚Ä®        tk.Button(frame_dias,‚Ä®                  text="Todos",‚Ä®                  command=lambda: self.seleccionar_todos_dias(True),‚Ä®                  bg="#95a5a6",‚Ä®                  fg="white",‚Ä®                  font=("Arial", 8),‚Ä®                  padx=5).pack(side=tk.LEFT, padx=5)‚Ä®‚Ä®        tk.Button(frame_dias,‚Ä®                  text="Ninguno",‚Ä®                  command=lambda: self.seleccionar_todos_dias(False),‚Ä®                  bg="#95a5a6",‚Ä®                  fg="white",‚Ä®                  font=("Arial", 8),‚Ä®                  padx=5).pack(side=tk.LEFT, padx=2)‚Ä®‚Ä®        # Bot√≥n a√±adir horario‚Ä®        frame_boton_add = tk.Frame(frame_horarios)‚Ä®        frame_boton_add.pack(pady=10)‚Ä®‚Ä®        tk.Button(frame_boton_add,‚Ä®                  text="‚ûï A√±adir Horario con D√≠as Seleccionados",‚Ä®                  command=self.anadir_horario,‚Ä®                  bg="#27ae60",‚Ä®                  fg="white",‚Ä®                  font=("Arial", 10, "bold"),‚Ä®                  cursor="hand2",‚Ä®                  padx=15,‚Ä®                  pady=8).pack()‚Ä®‚Ä®        # Lista de horarios‚Ä®        frame_lista = tk.Frame(frame_horarios)‚Ä®        frame_lista.pack(fill=tk.BOTH, expand=True, pady=10)‚Ä®‚Ä®        tk.Label(frame_lista,‚Ä®                 text="üìã Horarios programados:",‚Ä®                 font=("Arial", 10, "bold")).pack(anchor=tk.W)‚Ä®‚Ä®        # Listbox para horarios‚Ä®        frame_listbox = tk.Frame(frame_lista)‚Ä®        frame_listbox.pack(fill=tk.BOTH, expand=True)‚Ä®‚Ä®        self.lista_horarios = tk.Listbox(frame_listbox,‚Ä®                                         height=5,‚Ä®                                         font=("Courier", 10),‚Ä®                                         selectmode=tk.SINGLE)‚Ä®        self.lista_horarios.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)‚Ä®‚Ä®        scrollbar = tk.Scrollbar(frame_listbox, orient=tk.VERTICAL,‚Ä®                                 command=self.lista_horarios.yview)‚Ä®        self.lista_horarios.configure(yscrollcommand=scrollbar.set)‚Ä®        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)‚Ä®‚Ä®        tk.Button(frame_horarios,‚Ä®                  text="üóë Eliminar Horario Seleccionado",‚Ä®                  command=self.eliminar_horario,‚Ä®                  bg="#e74c3c",‚Ä®                  fg="white",‚Ä®                  font=("Arial", 9, "bold"),‚Ä®                  cursor="hand2",‚Ä®                  padx=10).pack(pady=5)‚Ä®‚Ä®        # CONTROL‚Ä®        frame_control = tk.LabelFrame(self.root,‚Ä®                                      text="üéÆ Control de Ejecuci√≥n",‚Ä®                                      font=("Arial", 11, "bold"),‚Ä®                                      padx=15, pady=15)‚Ä®        frame_control.pack(fill=tk.X, padx=10, pady=10)‚Ä®‚Ä®        frame_botones = tk.Frame(frame_control)‚Ä®        frame_botones.pack(pady=10)‚Ä®‚Ä®        self.btn_ejecutar = tk.Button(frame_botones,‚Ä®                                      text="‚ñ∂Ô∏è Ejecutar Fichaje AHORA",‚Ä®                                      command=self.ejecutar_ahora,‚Ä®                                      bg="#3498db",‚Ä®                                      fg="white",‚Ä®                                      font=("Arial", 11, "bold"),‚Ä®                                      cursor="hand2",‚Ä®                                      padx=20,‚Ä®                                      pady=10,‚Ä®                                      width=22)‚Ä®        self.btn_ejecutar.pack(side=tk.LEFT, padx=5)‚Ä®‚Ä®        self.btn_scheduler = tk.Button(frame_botones,‚Ä®                                       text="üöÄ Activar Programador",‚Ä®                                       command=self.toggle_scheduler,‚Ä®                                       bg="#f39c12",‚Ä®                                       fg="white",‚Ä®                                       font=("Arial", 11, "bold"),‚Ä®                                       cursor="hand2",‚Ä®                                       padx=20,‚Ä®                                       pady=10,‚Ä®                                       width=22)‚Ä®        self.btn_scheduler.pack(side=tk.LEFT, padx=5)‚Ä®‚Ä®        # Estado‚Ä®        self.label_estado = tk.Label(frame_control,‚Ä®                                     text="‚è∏ Estado: PROGRAMADOR INACTIVO",‚Ä®                                     font=("Arial", 11, "bold"),‚Ä®                                     fg="#e74c3c")‚Ä®        self.label_estado.pack(pady=10)‚Ä®‚Ä®        self.label_proxima = tk.Label(frame_control,‚Ä®                                      text="",‚Ä®                                      font=("Arial", 9),‚Ä®                                      fg="#7f8c8d")‚Ä®        self.label_proxima.pack()‚Ä®‚Ä®        # CONSOLA‚Ä®        frame_consola = tk.LabelFrame(self.root,‚Ä®                                      text="üìù Consola de Ejecuci√≥n en Tiempo Real",‚Ä®                                      font=("Arial", 11, "bold"),‚Ä®                                      padx=10, pady=10)‚Ä®        frame_consola.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)‚Ä®‚Ä®        self.consola = scrolledtext.ScrolledText(frame_consola,‚Ä®                                                 wrap=tk.WORD,‚Ä®                                                 width=100,‚Ä®                                                 height=10,‚Ä®                                                 font=("Consolas", 9),‚Ä®                                                 bg="#1e1e1e",‚Ä®                                                 fg="#00ff00",‚Ä®                                                 insertbackground="white")‚Ä®        self.consola.pack(fill=tk.BOTH, expand=True)‚Ä®‚Ä®        frame_botones_consola = tk.Frame(frame_consola)‚Ä®        frame_botones_consola.pack(pady=5)‚Ä®‚Ä®        tk.Button(frame_botones_consola,‚Ä®                  text="üßπ Limpiar Consola",‚Ä®                  command=self.limpiar_consola,‚Ä®                  bg="#95a5a6",‚Ä®                  fg="white",‚Ä®                  font=("Arial", 9),‚Ä®                  cursor="hand2",‚Ä®                  padx=10).pack(side=tk.LEFT, padx=5)‚Ä®‚Ä®        tk.Button(frame_botones_consola,‚Ä®                  text="üìÅ Abrir Carpeta de Screenshots",‚Ä®                  command=self.abrir_screenshots,‚Ä®                  bg="#9b59b6",‚Ä®                  fg="white",‚Ä®                  font=("Arial", 9),‚Ä®                  cursor="hand2",‚Ä®                  padx=10).pack(side=tk.LEFT, padx=5)‚Ä®‚Ä®        # Mensaje inicial‚Ä®        self.log_consola("=" * 80)‚Ä®        self.log_consola("üöÄ Sistema de Fichaje Automatizado v2.0 iniciado")‚Ä®        self.log_consola(f"üìÖ Fecha: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")‚Ä®        self.log_consola(f"üìÇ Carpeta de trabajo: {os.getcwd()}")‚Ä®        self.log_consola("=" * 80)‚Ä®        self.log_consola("")‚Ä®        self.log_consola("üìã INSTRUCCIONES:")‚Ä®        self.log_consola("1. Verifica que existe el archivo 'datos.csv'")‚Ä®        self.log_consola("2. Selecciona hora, minutos y d√≠as de la semana")‚Ä®        self.log_consola("3. A√±ade horarios de fichaje autom√°tico")‚Ä®        self.log_consola("4. Activa el programador o ejecuta manualmente")‚Ä®        self.log_consola("")‚Ä®        self.log_consola("‚ú® NUEVAS CARACTER√çSTICAS:")‚Ä®        self.log_consola("   ‚Ä¢ Selecci√≥n de d√≠as espec√≠ficos (L-D)")‚Ä®        self.log_consola("   ‚Ä¢ Modo Headless (Chrome invisible)")‚Ä®        self.log_consola("=" * 80)‚Ä®‚Ä®        # Cargar horarios‚Ä®        self.actualizar_lista_horarios()‚Ä®‚Ä®    def log_consola(self, mensaje):‚Ä®        """A√±ade mensaje a la consola"""‚Ä®        timestamp = datetime.now().strftime("%H:%M:%S")‚Ä®        self.consola.insert(tk.END, f"[{timestamp}] {mensaje}\n")‚Ä®        self.consola.see(tk.END)‚Ä®        self.root.update_idletasks()‚Ä®‚Ä®    def limpiar_consola(self):‚Ä®        """Limpia la consola"""‚Ä®        self.consola.delete(1.0, tk.END)‚Ä®        self.log_consola("Consola limpiada")‚Ä®‚Ä®    def seleccionar_csv(self):‚Ä®        """Abre di√°logo para seleccionar archivo CSV"""‚Ä®        filename = filedialog.askopenfilename(‚Ä®            title="Seleccionar archivo CSV",‚Ä®            filetypes=[("Archivos CSV", "*.csv"), ("Todos los archivos", "*.*")]‚Ä®        )‚Ä®        if filename:‚Ä®            self.csv_entry.delete(0, tk.END)‚Ä®            self.csv_entry.insert(0, filename)‚Ä®            CONFIG['csv_file'] = filename‚Ä®            self.log_consola(f"‚úÖ Archivo CSV seleccionado: {filename}")‚Ä®‚Ä®    def abrir_screenshots(self):‚Ä®        """Abre la carpeta de screenshots"""‚Ä®        try:‚Ä®            screenshot_path = os.path.abspath(CONFIG['screenshots_dir'])‚Ä®            if sys.platform == 'win32':‚Ä®                os.startfile(screenshot_path)‚Ä®            elif sys.platform == 'darwin':‚Ä®                os.system(f'open "{screenshot_path}"')‚Ä®            else:‚Ä®                os.system(f'xdg-open "{screenshot_path}"')‚Ä®            self.log_consola(f"üìÅ Abriendo carpeta: {screenshot_path}")‚Ä®        except Exception as e:‚Ä®            self.log_consola(f"‚ùå Error abriendo carpeta: {e}")‚Ä®‚Ä®    def toggle_headless(self):‚Ä®        """Activa/desactiva el modo headless"""‚Ä®        CONFIG['headless'] = self.headless_var.get()‚Ä®        estado = "activado" if CONFIG['headless'] else "desactivado"‚Ä®        self.log_consola(f"üîá Modo Headless {estado}")‚Ä®‚Ä®    def seleccionar_todos_dias(self, seleccionar):‚Ä®        """Selecciona o deselecciona todos los d√≠as"""‚Ä®        for var in self.dias_vars.values():‚Ä®            var.set(seleccionar)‚Ä®‚Ä®    def anadir_horario(self):‚Ä®        """A√±ade un horario a la lista con d√≠as espec√≠ficos"""‚Ä®        hora = self.hora_var.get().zfill(2)‚Ä®        minuto = self.minuto_var.get().zfill(2)‚Ä®        horario = f"{hora}:{minuto}"‚Ä®‚Ä®        # Obtener d√≠as seleccionados‚Ä®        dias_seleccionados = [dia for dia, var in self.dias_vars.items() if var.get()]‚Ä®‚Ä®        if not dias_seleccionados:‚Ä®            messagebox.showwarning("Sin D√≠as Seleccionados",‚Ä®                                   "Debes seleccionar al menos un d√≠a de la semana")‚Ä®            return‚Ä®‚Ä®        # Crear identificador √∫nico con horario y d√≠as‚Ä®        dias_str = ''.join(dias_seleccionados)‚Ä®        id_horario = f"{horario}_{dias_str}"‚Ä®‚Ä®        # Verificar que no existe ya esta combinaci√≥n exacta‚Ä®        if any(h["horario"] == horario and h["dias_str"] == dias_str for h in self.horarios):‚Ä®            messagebox.showwarning("Horario Duplicado",‚Ä®                                   f"El horario {horario} con estos d√≠as ya existe")‚Ä®            return‚Ä®‚Ä®        nuevo_horario = {‚Ä®            "horario": horario,‚Ä®            "dias": dias_seleccionados,‚Ä®            "dias_str": dias_str,‚Ä®            "activo": True,‚Ä®            "ultima_ejecucion": "Nunca"‚Ä®        }‚Ä®        self.horarios.append(nuevo_horario)‚Ä®‚Ä®        dias_texto = ', '.join(dias_seleccionados)‚Ä®        self.log_consola(f"‚úÖ Horario a√±adido: {horario} - D√≠as: {dias_texto}")‚Ä®        self.actualizar_lista_horarios()‚Ä®        self.guardar_configuracion()‚Ä®‚Ä®        if self.scheduler_running:‚Ä®            self.programar_tareas()‚Ä®‚Ä®    def eliminar_horario(self):‚Ä®        """Elimina el horario seleccionado"""‚Ä®        seleccion = self.lista_horarios.curselection()‚Ä®        if not seleccion:‚Ä®            messagebox.showinfo("Sin Selecci√≥n", "Selecciona un horario para eliminar")‚Ä®            return‚Ä®‚Ä®        index = seleccion[0]‚Ä®        horario = self.horarios[index]["horario"]‚Ä®‚Ä®        if messagebox.askyesno("Confirmar Eliminaci√≥n",‚Ä®                               f"¬øEliminar el horario {horario}?"):‚Ä®            self.horarios.pop(index)‚Ä®            self.log_consola(f"üóë Horario eliminado: {horario}")‚Ä®            self.actualizar_lista_horarios()‚Ä®            self.guardar_configuracion()‚Ä®‚Ä®            if self.scheduler_running:‚Ä®                self.programar_tareas()‚Ä®‚Ä®    def actualizar_lista_horarios(self):‚Ä®        """Actualiza la lista visual de horarios con d√≠as"""‚Ä®        self.lista_horarios.delete(0, tk.END)‚Ä®‚Ä®        for h in sorted(self.horarios, key=lambda x: x["horario"]):‚Ä®            estado = "‚úÖ ACTIVO" if h["activo"] else "‚ùå INACTIVO"‚Ä®            dias = ', '.join(h.get("dias", ["L", "M", "X", "J", "V", "S", "D"]))‚Ä®            texto = f"{h['horario']} - D√≠as:[{dias}] - {estado} - √öltima:{h['ultima_ejecucion']}"‚Ä®            self.lista_horarios.insert(tk.END, texto)‚Ä®‚Ä®    def ejecutar_ahora(self):‚Ä®        """Ejecuta el fichaje inmediatamente"""‚Ä®        # Actualizar CSV si cambi√≥‚Ä®        CONFIG['csv_file'] = self.csv_entry.get()‚Ä®        # Actualizar headless desde checkbox‚Ä®        CONFIG['headless'] = self.headless_var.get()‚Ä®‚Ä®        self.log_consola("=" * 80)‚Ä®        self.log_consola("‚ñ∂Ô∏è EJECUTANDO FICHAJE MANUAL...")‚Ä®        if CONFIG['headless']:‚Ä®            self.log_consola("üîá Modo: Headless (Chrome invisible)")‚Ä®        else:‚Ä®            self.log_consola("üëÅÔ∏è Modo: Visible (Chrome con ventana)")‚Ä®        self.log_consola("=" * 80)‚Ä®‚Ä®        self.btn_ejecutar.config(state=tk.DISABLED, text="‚è≥ Ejecutando...")‚Ä®‚Ä®        thread = threading.Thread(target=self._ejecutar_thread)‚Ä®        thread.daemon = True‚Ä®        thread.start()‚Ä®‚Ä®    def _ejecutar_thread(self):‚Ä®        """Ejecuta el fichaje en thread separado"""‚Ä®        try:‚Ä®            resultado = self.engine.procesar_usuarios(callback=self.log_consola)‚Ä®            self.log_consola("‚úÖ Ejecuci√≥n completada")‚Ä®        except Exception as e:‚Ä®            self.log_consola(f"‚ùå ERROR: {e}")‚Ä®        finally:‚Ä®            self.btn_ejecutar.config(state=tk.NORMAL, text="‚ñ∂Ô∏è Ejecutar Fichaje AHORA")‚Ä®‚Ä®    def toggle_scheduler(self):‚Ä®        """Activa/desactiva el programador"""‚Ä®        if self.scheduler_running:‚Ä®            self.detener_scheduler()‚Ä®        else:‚Ä®            self.iniciar_scheduler()‚Ä®‚Ä®    def iniciar_scheduler(self):‚Ä®        """Inicia el programador de tareas"""‚Ä®        if not self.horarios:‚Ä®            messagebox.showwarning("Sin Horarios",‚Ä®                                   "A√±ade al menos un horario antes de activar el programador")‚Ä®            return‚Ä®‚Ä®        self.scheduler_running = True‚Ä®        self.btn_scheduler.config(text="‚è∏ Detener Programador", bg="#e74c3c")‚Ä®        self.label_estado.config(text="‚úÖ Estado: PROGRAMADOR ACTIVO", fg="#27ae60")‚Ä®‚Ä®        self.log_consola("=" * 80)‚Ä®        self.log_consola("üöÄ PROGRAMADOR DE TAREAS ACTIVADO")‚Ä®        self.log_consola("=" * 80)‚Ä®‚Ä®        self.programar_tareas()‚Ä®‚Ä®        self.scheduler_thread = threading.Thread(target=self._run_scheduler)‚Ä®        self.scheduler_thread.daemon = True‚Ä®        self.scheduler_thread.start()‚Ä®‚Ä®    def detener_scheduler(self):‚Ä®        """Detiene el programador de tareas"""‚Ä®        self.scheduler_running = False‚Ä®        schedule.clear()‚Ä®‚Ä®        self.btn_scheduler.config(text="üöÄ Activar Programador", bg="#f39c12")‚Ä®        self.label_estado.config(text="‚è∏ Estado: PROGRAMADOR INACTIVO", fg="#e74c3c")‚Ä®        self.label_proxima.config(text="")‚Ä®‚Ä®        self.log_consola("=" * 80)‚Ä®        self.log_consola("‚è∏ PROGRAMADOR DE TAREAS DETENIDO")‚Ä®        self.log_consola("=" * 80)‚Ä®‚Ä®    def programar_tareas(self):‚Ä®        """Programa todas las tareas con d√≠as espec√≠ficos"""‚Ä®        schedule.clear()‚Ä®‚Ä®        # Mapeo de d√≠as a funciones de schedule‚Ä®        dias_schedule = {‚Ä®            'L': 'monday',‚Ä®            'M': 'tuesday',‚Ä®            'X': 'wednesday',‚Ä®            'J': 'thursday',‚Ä®            'V': 'friday',‚Ä®            'S': 'saturday',‚Ä®            'D': 'sunday'‚Ä®        }‚Ä®‚Ä®        for h in self.horarios:‚Ä®            if h["activo"]:‚Ä®                horario = h["horario"]‚Ä®                dias = h.get("dias", ["L", "M", "X", "J", "V", "S", "D"])‚Ä®‚Ä®                for dia_letra in dias:‚Ä®                    dia_schedule = dias_schedule.get(dia_letra)‚Ä®                    if dia_schedule:‚Ä®                        # Programar para cada d√≠a espec√≠fico‚Ä®                        getattr(schedule.every(), dia_schedule).at(horario).do(‚Ä®                            self._tarea_programada, horario, h‚Ä®                        )‚Ä®‚Ä®                dias_texto = ', '.join(dias)‚Ä®                self.log_consola(f"‚è∞ Programado: {horario} - D√≠as: {dias_texto}")‚Ä®‚Ä®        if schedule.jobs:‚Ä®            proxima = schedule.next_run()‚Ä®            if proxima:‚Ä®                texto_proxima = proxima.strftime('%d/%m/%Y %H:%M:%S')‚Ä®                dia_semana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'][‚Ä®                    proxima.weekday()]‚Ä®                self.log_consola(f"üìÖ Pr√≥xima ejecuci√≥n: {dia_semana} {texto_proxima}")‚Ä®                self.label_proxima.config(text=f"Pr√≥xima: {dia_semana} {texto_proxima}")‚Ä®‚Ä®    def _tarea_programada(self, horario_str, horario_obj):‚Ä®        """Funci√≥n que se ejecuta cuando llega la hora"""‚Ä®        dias_texto = ', '.join(horario_obj.get("dias", []))‚Ä®        self.log_consola("=" * 80)‚Ä®        self.log_consola(f"‚è∞ TAREA PROGRAMADA - {horario_str} - D√≠as: [{dias_texto}]")‚Ä®        self.log_consola("=" * 80)‚Ä®‚Ä®        horario_obj["ultima_ejecucion"] = datetime.now().strftime("%d/%m/%Y %H:%M:%S")‚Ä®        self.actualizar_lista_horarios()‚Ä®        self.guardar_configuracion()‚Ä®‚Ä®        self._ejecutar_thread()‚Ä®‚Ä®    def _run_scheduler(self):‚Ä®        """Loop del scheduler"""‚Ä®        while self.scheduler_running:‚Ä®            schedule.run_pending()‚Ä®            time.sleep(1)‚Ä®‚Ä®    def cargar_configuracion(self):‚Ä®        """Carga la configuraci√≥n guardada"""‚Ä®        try:‚Ä®            config_file = CONFIG['config_file']‚Ä®            if os.path.exists(config_file):‚Ä®                with open(config_file, 'r') as f:‚Ä®                    data = json.load(f)‚Ä®                    self.horarios = data.get("horarios", [])‚Ä®        except Exception as e:‚Ä®            self.horarios = []‚Ä®‚Ä®    def guardar_configuracion(self):‚Ä®        """Guarda la configuraci√≥n"""‚Ä®        try:‚Ä®            with open(CONFIG['config_file'], 'w') as f:‚Ä®                json.dump({"horarios": self.horarios}, f, indent=4)‚Ä®        except Exception as e:‚Ä®            print(f"Error guardando config: {e}")‚Ä®‚Ä®    def on_closing(self):‚Ä®        """Maneja el cierre de la aplicaci√≥n"""‚Ä®        if self.scheduler_running:‚Ä®            respuesta = messagebox.askyesno(‚Ä®                "Programador Activo",‚Ä®                "El programador est√° activo.\n\n"‚Ä®                "¬øSeguro que quieres cerrar?\n"‚Ä®                "Las tareas programadas se detendr√°n."‚Ä®            )‚Ä®            if not respuesta:‚Ä®                return‚Ä®            self.detener_scheduler()‚Ä®‚Ä®        self.guardar_configuracion()‚Ä®        self.root.destroy()‚Ä®‚Ä®‚Ä®# ==================== FUNCI√ìN PRINCIPAL ====================‚Ä®def main():‚Ä®    """Funci√≥n principal que inicia la aplicaci√≥n"""‚Ä®‚Ä®    # Crear motor de fichaje‚Ä®    engine = FichajeEngine(CONFIG)‚Ä®‚Ä®    # Crear ventana principal‚Ä®    root = tk.Tk()‚Ä®‚Ä®    # Crear GUI‚Ä®    app = FichajeGUI(root, engine)‚Ä®‚Ä®    # Iniciar bucle de eventos‚Ä®    root.mainloop()‚Ä®‚Ä®‚Ä®if __name__ == "__main__":‚Ä®    main()

